# GARDIAN Project - AI Agent Instructions

## Project Overview

GARDIAN (Geospatial Aid Response & Disaster Information Analysis Network) is a **two-application system** for Non-combatant Evacuation Operations (NEO):

1. **Dashboard/** - React/Vite web app for command centres (MapLibre + AWS Location Service)
2. **SafePassage/** - Native iOS app for field personnel (SwiftUI + AWS Amplify)

**Critical Architecture Decision**: The two applications are loosely coupled through AWS backend services. The iOS app submits hazard reports via AWS AppSync (GraphQL), while the Dashboard polls entitled-person data from a separate REST API endpoint. They share AWS infrastructure but use different data access patterns.

## Development Environment Setup

### Dashboard (React)
```powershell
cd Dashboard
# Create .env with required keys (see Dashboard/.env for example)
npm install
npm run dev          # Vite dev server on http://localhost:5173
npm run lint         # ESLint with React Hooks rules
npm run build        # Production build â†’ dist/
```

### SafePassage (iOS)
- Requires macOS, Xcode 14+, iOS 16+ device/simulator
- **Always** run Amplify commands from `SafePassage/` root directory
- `amplifyconfiguration.json` is generated by Amplify CLI - never manually edit
- Open `SafePassage.xcodeproj` in Xcode to build/run

## Critical Patterns & Conventions

### Environment Variables (Dashboard)
All environment variables **MUST** be prefixed with `VITE_` to be exposed to the browser by Vite:

```javascript
// Dashboard/src/App.jsx
const apiKey = import.meta.env.VITE_AWS_LOCATION_KEY;
const geoJsonUrl = import.meta.env.VITE_GEOJSON_URL || "https://zones-of-interest.s3...";
```

**Security Note**: Browser-exposed keys are intentional for this hackathon prototype. Production systems should proxy API calls through a backend to hide credentials.

### Shared Map Architecture (Dashboard)
The Dashboard uses a **shared mapRef pattern** to coordinate multiple React components operating on the same MapLibre instance:

```jsx
// App.jsx creates the ref and passes it to both components
const mapRef = useRef(null);

<MapLibreMap mapRef={mapRef} apiKey={apiKey} geoJsonUrl={geoJsonUrl} />
<PinDataFetcher mapRef={mapRef} pinJsonUrl={pinJsonUrl} />
```

`MapLibreMap` initializes the map and sets `mapRef.current`. `PinDataFetcher` adds pin markers to the same map instance. **Never** create multiple MapLibre instances - always use the shared ref.

### Data Source URLs (Dashboard)
Hardcoded for hackathon demo - **should be promoted to env vars for production**:

- **Entitled-person API**: `https://ksip4rkha0.execute-api.eu-west-2.amazonaws.com/entitled-persons` (in `PinDataFetcher.jsx`)
- **Messaging router**: `https://ksip4rkha0.execute-api.eu-west-2.amazonaws.com/messaging-router` (in `PinDataFetcher.jsx`)
- **GeoJSON hazard zones**: Configurable via `VITE_GEOJSON_URL` (defaults to S3 bucket)

### iOS Amplify Initialization (SafePassage)
Amplify plugins **must** be configured in the correct order in `SafePassageApp.swift`:

```swift
try Amplify.add(plugin: AWSCognitoAuthPlugin())
try Amplify.add(plugin: AWSAPIPlugin(modelRegistration: AmplifyModels()))
try Amplify.add(plugin: AWSS3StoragePlugin())
try Amplify.configure()  // Must be last
```

Always inject services as `@EnvironmentObject` from the root `WindowGroup` to ensure single instances across views.

### GraphQL Authorization Pattern (SafePassage)
The schema enforces **owner-based authorization**:

```graphql
type Report @model @auth(rules: [{ allow: owner }]) {
  id: ID!
  name: String!
  // ... fields
}
```

Users only see/modify their own reports. If you need to show all reports to dashboard users, the backend API must use a service account or different auth pattern (not implemented yet).

### Theme Management (Dashboard)
Theme state is persisted to `localStorage` and applied via CSS custom properties:

```javascript
// App.jsx
const [theme, setTheme] = useState(getPreferredTheme);
document.documentElement.setAttribute("data-app-theme", theme);
```

All theme-specific styles use the `data-app-theme` attribute selector in `App.css`. Default is dark mode.

### Component Cleanup Patterns (Dashboard)
MapLibre and React 19 require careful cleanup to prevent memory leaks:

```javascript
useEffect(() => {
  // Setup map layers...
  
  return () => {
    // ALWAYS remove layers before sources
    if (map.getLayer(layerId)) map.removeLayer(layerId);
    if (map.getSource(sourceId)) map.removeSource(sourceId);
    
    // Unmount React roots for popups
    popupRootsRef.current.forEach(root => root.unmount());
  };
}, [dependencies]);
```

### Async/Await Pattern (SafePassage)
All Amplify operations use Swift's async/await with `@MainActor` services:

```swift
@MainActor
class ReportsService: ObservableObject {
    @Published var reports: [Report] = []
    
    func fetchReports() async {
        let result = try await Amplify.API.query(request: .list(Report.self))
        // UI updates automatically via @Published
    }
}
```

Always mark service classes as `@MainActor` to ensure UI updates happen on the main thread.

## Key Files & Their Responsibilities

### Dashboard
- **src/App.jsx**: Root layout, theme management, shared mapRef, contact directory, section composition
- **src/components/MapLibreMap.jsx**: AWS Location Service initialization, GeoJSON hazard layer rendering, bounds fitting
- **src/components/PinDataFetcher.jsx**: Entitled-person pin overlay, interactive popups, messaging dispatch
- **src/components/NewsFeed.jsx**: Multi-source news aggregation (GNews, Guardian, GDELT) with geolocation
- **vite.config.js**: Guardian API CORS proxy configuration (fixes duplicate header bug)
- **.env**: API keys - **NEVER commit to repo**

### SafePassage
- **SafePassageApp.swift**: Amplify initialization, service injection
- **ViewModel/ReportsService.swift**: GraphQL CRUD operations for reports
- **ViewModel/StorageService.swift**: S3 image upload/download/delete
- **ViewModel/AuthenticationService.swift**: Cognito sign-in/out flow
- **amplify/backend/api/safepassage/schema.graphql**: Data model definition with auth rules
- **amplifyconfiguration.json**: Auto-generated AWS config - **NEVER manually edit**

## Common Troubleshooting

### Dashboard won't start
- Verify `.env` exists with `VITE_AWS_LOCATION_KEY`
- Check terminal output for missing peer dependencies
- Ensure Node.js 18+ installed

### iOS app "Amplify has not been configured"
- Verify `amplifyconfiguration.json` exists in project root
- Check Xcode build logs for Amplify initialization errors
- Run `amplify pull` to sync latest backend config

### Map layers not appearing
- Check browser console for CORS errors on GeoJSON/pin endpoints
- Verify AWS Location Service key is valid and not expired
- Ensure GeoJSON structure matches expected FeatureCollection format

### Pins showing wrong color
- Pin colors are based on `to_evacuate` boolean property
- Backend may send strings ("true"/"false") - `PinDataFetcher` normalizes these
- Red = evacuate requested, Green = no evacuation, Gray = unknown

## Testing & Quality

- Dashboard uses ESLint with React Hooks plugin - fix warnings before committing
- iOS app has no automated tests yet - manual testing required
- Print statements are acceptable for debugging (both `console.log` and Swift `print()`)
- No CI/CD pipeline configured - builds are manual

## Future Enhancements Noted in READMEs

- Real-time tracking instead of snapshot positions
- Live news feed auto-refresh (currently only loads once)
- Manual pin/polygon drawing on Dashboard
- Offline mode for both apps
- LLM analysis of news and weather
- Voice interaction for accessibility
